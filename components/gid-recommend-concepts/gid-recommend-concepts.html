<!--
  Wrapper data component for fetching and verifying recommended concepts
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../gid-api/gid-api.html">

<!--
`gid-recommend-concepts`

A data component acting as a wrapper  on gid-api used for handling rest calls for  fetching
recommended concepts against a particular column and then verifying one/more concept(s)


   The following is used for fetching the recommended concepts against a particular column.
  
    <gid-recommend-concepts
     api-url="https://ql50yzu0fj.execute-api.us-east-1.amazonaws.com/dev" column = '200009' 
	 fetch-recommended-concepts = true recommendedconcepts = {{recommendedconcepts}}>
	</gid-recommend-concepts>
 
  The field 'column' and 'fetch-recommended-concepts' are mandatory.
  
  The field 'fetch-recommended-concepts' needs to be set to 'true' in order to fetch recommended concepts
  
  The property 'recommendedconcepts' returns the response against the rest call.
 
   API endpoint:

    GET /columns/{id}/domains         

   Input:

     - Column Id 

   Sample Input: (Query params)

     GET /columns/200009/domains
     
   Output:

     - List of recommended concepts


   The output of this components will be as follows:

	{
	   "domains":[
	      {
		 "id":"4920055981064928686",
		 "label":"Last Name",
		 "verified":"N",
		 "relevance":"1.54"
	      },
	      {
		 "id":"221188726146740308",
		 "label":"Date of Birth",
		 "verified":"N",
		 "relevance":"5.88"
	      },
	      {
		 "id":"-886082613329644447",
		 "label":"First Name",
		 "verified":"N",
		 "relevance":"5.88"
	      }
	   ],
	   "_meta":{
	      "total":3,
	      "offset":0,
	      "limit":10
	   }
	}



   The following is used for verifying a particular recommended concept.
    
		<gid-recommend-concepts
		api-url="https://ql50yzu0fj.execute-api.us-east-1.amazonaws.com/dev"
		column = '200009'
		be-verified = true
		concept = '100002'
		verify-val = 'YES'
		verifiedconcepts = {{verifiedconcepts}}> 
		</gid-recommend-concepts>

   The field 'column' , 'concept',  'verify-val' and 'be-verified' are mandatory.
  
   The field 'be-verified' needs to be set to 'true' in order to verify a particular concept.
  
   The property 'verifiedconcepts' returns the response against the rest call.	
		
   API endpoint:

    PUT /columns/{columnId}/recommendedconcepts/{conceptId}
    
   Sample Input: (Query params)

     PUT /columns/200009/recommendedconcepts/100002/verify?hv=Y

   Input:

     - Column Id 
     - Concept Id

   Output:

     - Details of the concept verified
     
   The output of this components will be as follows:

	  {
	    "id": "4920055981064928686",
	    "label": "Last Name",
	    "verified": "Y",
	    "relevance": 1.54,
	    "lastUpdated": 1503508128418
	  }


@demo demo/index.html
-->
<dom-module id="gid-recommend-concepts">
	<template>

		<!-- fetch entity path  -->
		<gid-api entity = '{{apiEntity}}' path-key= '{{pathKey}}' path='{{path}}'></gid-api>
		<!--  fetch entity path -->

		<!-- fetch recommended concepts  -->
		<gid-api auto=false
				 method='GET' api-url={{recommendedConceptUrl}} response='{{recommendedConceptResponse}}'
				 error = '{{recommendedConceptError}}'
				 api-params={{recommendedConceptParams}} api-token={{recommendedConceptsToken}}
				 api-timeout={{recommendedConceptParams}}></gid-api>
		<!-- fetch recommended concepts  -->

		<!-- verify concept -->
		<gid-api auto=false
				 method='PUT' api-url={{verifyConceptUrl}} api-content-type = 'application/x-www-form-urlencoded'
				 response='{{verifyConceptResponse}}' error = '{{verifyConceptError}}'
				 api-params={{verifyConceptParams}} api-token={{verifyConceptToken}}
				 api-timeout={{verifyConceptParams}}></gid-api>
		<!-- verify concept -->

	</template>
	<script>
		(function () {
			'use strict';
			Polymer({
				is: 'gid-recommend-concepts',
				properties: {
					apiToken: {
						type: String,
						notify: true,
						value : ''
					},
					verifyConceptUrl: {
						type: String,
						notify: true
					},
					verifyConceptTimeout: {
						type: Number,
						notify: true,
						value: 0
					},
					verifyConceptResponse: {
						type: Object,
						notify: true,
						observer: 'verifyResponseReceived'
					},
					verifyConceptError : {
			 	   		type: String,
		 	   	    	notify: true,
		 	   	    	observer : 'verifyErrorReceived'
		 	   		},
					verifyConceptParams: {
						type: String,
						notify: true
					},
					verifyConceptToken: {
						type: String,
						notify: true
					},
					recommendedConceptUrl: {
						type: String,
						notify: true
					},
					recommendedConceptTimeout: {
						type: Number,
						notify: true,
						value: 0
					},
					recommendedConceptResponse: {
						type: Object,
						notify: true,
						observer: 'recommendedResponseReceived'
					},
					recommendedConceptError : {
			 	   		type: String,
		 	   	    	notify: true,
		 	   	    	observer : 'recommendedErrorReceived'
		 	   		},
					recommendedConceptParams: {
						type: String,
						notify: true
					},
					recommendedConceptsToken: {
						type: String,
						notify: true
					},
					concept: {
						type: String,
						notify: true,
						value: ''
					},
					column: {
						type: String,
						notify: true,
						value: ''
					},
					apiUrl: {
						type: String,
						notify: true,
						value: ''
					},
					verifyVal:{
						type: String,
						notify: true,
						value: ''
					},
					beVerified:{
						type: Boolean,
						notify: true,
						value: false,
						observer: 'beVerifiedObserver'
					},
					fetchRecommendedConcepts : {
						type: Boolean,
						notify: true,
						value: false,
						observer: 'fetchRecommendedConceptsObserver'
					},
					verifiedconcepts: {
						type: Array,
						notify: true
					},
					recommendedconcepts: {
						type: Array,
						notify: true
					},
					path: {
						type: String,
						notify: true,
						value: '',
						observer: 'pathReceived'
					},
					apiEntity: {
						type: String,
						notify: true
					}
				},
				pathReceived: function(){
					var url = '';
					var verify = '';
					if(this.path){
						var res = this.path.split(/{([^}]+)}/);
						for (var i in res) {
							if(!res[i].startsWith("/")){
								if(this[res[i]]){
									res[i] = this[res[i]];
								}
							}
						}
						url = this.apiUrl + res.join("");
						if(this.column && !this.beVerified){
							this.recommendedConceptUrl = url;
							if(this.apiToken){
								this.recommendedConceptsToken =  this.apiToken;
							}
							this.recommendedConceptTimeout =  this.recommendedConceptTimeout - 1;
						}
						else if(this.column && this.verifyVal && this.beVerified){
							this.verifyConceptUrl = url;
							if(this.verifyVal === "YES"){
								verify = 'Y';
							}
							else if(this.verifyVal === "NO"){
								verify = 'F';
							}
							else{
								verify = 'N';
							}
							this.verifyConceptParams= JSON.stringify({
								"verified": verify});
							if(this.apiToken){
								this.verifyConceptToken =  this.apiToken;
							}
							this.verifyConceptTimeout =  this.verifyConceptTimeout - 1;
						}

					}
				},
				fetchRecommendedConceptsObserver: function(){
					if(this.fetchRecommendedConcepts){
						if(this.column && !this.beVerified){
							if (!this.apiUrl) {
								this.recommendedConceptUrl = this.importPath + 'assets/json/recommended-concepts.json';
								this.recommendedConceptTimeout =  this.recommendedConceptTimeout - 1;
							}
							else{
								this.pathKey =  'default';
								this.apiEntity = 'RECOMMENDED-CONCEPTS';
							}
						}
					}

				},
				beVerifiedObserver: function () {
					if(this.beVerified) {
						if (this.column && this.verifyVal) {
							if (!this.apiUrl) {
								//this.verifyConceptUrl = this.importPath + 'assets/json/verify-concept.json';
								//this.verifyConceptTimeout =  this.verifyConceptTimeout - 1;
							}
							else {
								this.pathKey =  'default';
								this.apiEntity = 'VERIFY-CONCEPT';
							}
						}
					}

				},

				verifyResponseReceived: function (newvalue, oldvalue) {
					this.verifiedconcepts = [];
					this.reset();
					if (newvalue != null) {
						this.async(function () {
							this.verifiedconcepts = this.verifiedconcepts.concat(newvalue);
						}, 500);
					}
				},
				verifyErrorReceived :  function(newvalue, oldvalue){
					this.verifiedconcepts = [];
		   		  	 this.reset();
			        	if(newvalue !== null){
			        		this.async(function() {
				         		this.verifiedconcepts =  newvalue.response;
				   		 	          }, 500);
			        	}
			     },
				recommendedResponseReceived: function(newvalue, oldvalue) {
					this.recommendedconcepts = [];
					this.reset();
					if (newvalue != null) {
						this.async(function () {
							this.recommendedconcepts = this.recommendedconcepts.concat(newvalue.domains);
						}, 500);
					}
				},
				recommendedErrorReceived :  function(newvalue, oldvalue){
					this.recommendedconcepts = [];
		   		  	 this.reset();
			        	if(newvalue !== null){
			        		this.async(function() {
				         		this.recommendedconcepts =  newvalue.response;
				   		 	          }, 500);
			        	}
			     },
				reset: function(){
					this.apiEntity = '';
					this.path = '';
					this.fetchRecommendedConcepts = false;
					this.beVerified = false;
				}
			});
		})();


	</script>
</dom-module>
